<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <title>Stockages - SAGL</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><h1>SAGL</h1><p>Gestion d'inventaire</p></div>
            <nav class="sidebar-nav">
                <a href="index.html"><span class="icon" id="nav-icon-dashboard"></span> Tableau de bord</a>
                <a href="materials.html"><span class="icon" id="nav-icon-materials"></span> Matériels</a>
                <a href="storages.html" class="active"><span class="icon" id="nav-icon-storages"></span> Stockages</a>
                <a href="history.html"><span class="icon" id="nav-icon-history"></span> Historique</a>
                <a href="stats.html"><span class="icon" id="nav-icon-stats"></span> Statistiques</a>
                <a href="settings.html"><span class="icon" id="nav-icon-settings"></span> Paramètres</a>
            </nav>
            <div class="sidebar-footer"><p>SAGL v1.0</p></div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <button class="menu-btn" id="menu-btn"></button>
                <div style="flex:1"></div>
                <div class="topbar-right">
                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notification-btn"><span id="notification-bell-icon"></span><span class="notification-count" id="notification-count" style="display:none">0</span></button>
                        <div class="notification-dropdown" id="notification-dropdown" style="display:none"><div class="notification-dropdown-header">Notifications (<span id="notif-count-text">0</span>)</div><div id="notification-list"></div></div>
                    </div>
                    <span class="topbar-username" id="topbar-username"></span>
                    <button class="btn-icon" id="logout-btn" title="Déconnexion"></button>
                </div>
            </header>

            <main class="page-content" id="page-content">
                <div class="spinner-center"><div class="spinner"></div></div>
            </main>
        </div>
    </div>

    <!-- Modal création -->
    <div class="modal-overlay" id="modal" style="display:none">
        <div class="modal">
            <div class="modal-header">
                <h2>Nouveau stockage</h2>
                <button class="btn-icon" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="storage-form">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" id="storage-name" class="input-field" placeholder="Ex: Ambulance 1, Sac de soin..." required>
                    </div>
                    <div class="form-group">
                        <label>Stockage parent (optionnel)</label>
                        <select id="storage-parent" class="input-field">
                            <option value="">Aucun (stockage racine)</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Créer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script>
        if (!checkAuth()) throw new Error('Not authenticated');

        document.getElementById('menu-btn').innerHTML = icons.menu;
        document.getElementById('notification-bell-icon').innerHTML = icons.bell;
        document.getElementById('logout-btn').innerHTML = icons.logout;
        document.getElementById('nav-icon-dashboard').innerHTML = icons.dashboard;
        document.getElementById('nav-icon-materials').innerHTML = icons.package;
        document.getElementById('nav-icon-storages').innerHTML = icons.folderTree;
        document.getElementById('nav-icon-history').innerHTML = icons.clipboardList;
        document.getElementById('nav-icon-stats').innerHTML = icons.barChart;
        document.getElementById('nav-icon-settings').innerHTML = icons.settings;
        initSidebar();

        let treeData = [];
        let flatList = [];
        let expandedNodes = {};

        async function loadData() {
            try {
                const [tree, list] = await Promise.all([storages.tree(), storages.list()]);
                treeData = tree;
                flatList = list;
                renderTree();
                populateParentSelect();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function renderTree() {
            let html = `
                <div class="page-header">
                    <h1 class="page-title">Stockages</h1>
                    <button class="btn-primary" onclick="openCreateModal()">${icons.plus} <span class="hidden-mobile">Nouveau stockage</span></button>
                </div>
                <div class="card">
            `;

            if (treeData.length === 0) {
                html += '<p style="text-align:center;padding:32px;color:var(--gray-500)">Aucun stockage. Créez-en un !</p>';
            } else {
                html += '<div class="space-y-1">';
                treeData.forEach(node => html += renderNode(node, 0));
                html += '</div>';
            }

            html += '</div>';
            document.getElementById('page-content').innerHTML = html;
        }

        function renderNode(node, depth) {
            const hasChildren = node.children && node.children.length > 0;
            const isExpanded = expandedNodes[node.id] !== false && depth < 2;
            if (expandedNodes[node.id] === undefined && depth < 2) expandedNodes[node.id] = true;

            let html = '<div>';
            html += '<div class="tree-node" style="padding-left:' + (depth * 24 + 12) + 'px">';

            if (hasChildren) {
                html += '<button class="tree-toggle" onclick="toggleNode(' + node.id + ')">' +
                    (isExpanded ? icons.chevronDown : icons.chevronRight) + '</button>';
            } else {
                html += '<span class="tree-spacer"></span>';
            }

            const iconColor = node.isGlobalStock ? 'color:var(--amber-600)' : 'color:var(--primary-600)';
            html += '<span class="tree-icon" style="' + iconColor + '">' +
                (node.isGlobalStock ? icons.warehouse : icons.folderTree) + '</span>';

            html += '<a href="storage-detail.html?id=' + node.id + '" class="tree-name">' +
                escapeHtml(node.name) + '</a>';

            if (node.isGlobalStock) {
                html += '<span class="badge badge-amber">Réserve</span>';
            }
            if (node.uniqueLink) {
                html += '<span class="badge badge-green">Lien actif</span>';
            }

            html += '<span class="tree-meta">' + (node.templateItems?.length || 0) + ' matériel(s)</span>';
            html += '</div>';

            if (isExpanded && hasChildren) {
                node.children.forEach(child => html += renderNode(child, depth + 1));
            }

            html += '</div>';
            return html;
        }

        function toggleNode(id) {
            expandedNodes[id] = !expandedNodes[id];
            renderTree();
        }

        function populateParentSelect() {
            const select = document.getElementById('storage-parent');
            select.innerHTML = '<option value="">Aucun (stockage racine)</option>';
            flatList.filter(s => !s.isGlobalStock).forEach(s => {
                const prefix = s.parent ? s.parent.name + ' > ' : '';
                select.innerHTML += '<option value="' + s.id + '">' + escapeHtml(prefix + s.name) + '</option>';
            });
        }

        function openCreateModal() {
            document.getElementById('storage-name').value = '';
            document.getElementById('storage-parent').value = '';
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        document.getElementById('storage-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('storage-name').value;
            const parentId = document.getElementById('storage-parent').value;

            try {
                await storages.create({
                    name,
                    parentId: parentId ? parseInt(parentId) : undefined,
                });
                showToast('Stockage créé');
                closeModal();
                loadData();
            } catch (err) {
                showToast(err.message, 'error');
            }
        });

        loadData();
    </script>
</body>
</html>
