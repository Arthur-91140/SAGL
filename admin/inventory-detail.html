<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <title>Détail inventaire - SAGL</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><h1>SAGL</h1><p>Gestion d'inventaire</p></div>
            <nav class="sidebar-nav">
                <a href="index.html"><span class="icon" id="nav-icon-dashboard"></span> Tableau de bord</a>
                <a href="materials.html"><span class="icon" id="nav-icon-materials"></span> Matériels</a>
                <a href="storages.html"><span class="icon" id="nav-icon-storages"></span> Stockages</a>
                <a href="history.html" class="active"><span class="icon" id="nav-icon-history"></span> Historique</a>
                <a href="stats.html"><span class="icon" id="nav-icon-stats"></span> Statistiques</a>
                <a href="settings.html"><span class="icon" id="nav-icon-settings"></span> Paramètres</a>
            </nav>
            <div class="sidebar-footer"><p>SAGL v1.0</p></div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <button class="menu-btn" id="menu-btn"></button>
                <div style="flex:1"></div>
                <div class="topbar-right">
                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notification-btn"><span id="notification-bell-icon"></span><span class="notification-count" id="notification-count" style="display:none">0</span></button>
                        <div class="notification-dropdown" id="notification-dropdown" style="display:none"><div class="notification-dropdown-header">Notifications (<span id="notif-count-text">0</span>)</div><div id="notification-list"></div></div>
                    </div>
                    <span class="topbar-username" id="topbar-username"></span>
                    <button class="btn-icon" id="logout-btn" title="Déconnexion"></button>
                </div>
            </header>

            <main class="page-content" id="page-content">
                <div class="spinner-center"><div class="spinner"></div></div>
            </main>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script>
        if (!checkAuth()) throw new Error('Not authenticated');

        document.getElementById('menu-btn').innerHTML = icons.menu;
        document.getElementById('notification-bell-icon').innerHTML = icons.bell;
        document.getElementById('logout-btn').innerHTML = icons.logout;
        document.getElementById('nav-icon-dashboard').innerHTML = icons.dashboard;
        document.getElementById('nav-icon-materials').innerHTML = icons.package;
        document.getElementById('nav-icon-storages').innerHTML = icons.folderTree;
        document.getElementById('nav-icon-history').innerHTML = icons.clipboardList;
        document.getElementById('nav-icon-stats').innerHTML = icons.barChart;
        document.getElementById('nav-icon-settings').innerHTML = icons.settings;
        initSidebar();

        const typeLabels = { START: 'Début de mission', END: 'Fin de mission', OTHER: 'Autre' };
        const invId = parseInt(new URLSearchParams(window.location.search).get('id'));

        async function loadDetail() {
            try {
                const inv = await inventories.get(invId);

                // Group by storage
                const groups = new Map();
                inv.items.forEach(item => {
                    const key = item.storage.name;
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push(item);
                });

                let html = `
                    <div class="flex items-center gap-3 mb-6">
                        <a href="history.html" class="btn-icon">${icons.arrowLeft}</a>
                        <h1 class="page-title">Détail de l'inventaire</h1>
                    </div>

                    <div class="card mb-6">
                        <div class="grid grid-4">
                            <div><p class="text-xs text-gray-500" style="text-transform:uppercase;letter-spacing:0.05em">Secouriste</p><p class="font-semibold">${escapeHtml(inv.rescuerName)}</p></div>
                            <div><p class="text-xs text-gray-500" style="text-transform:uppercase;letter-spacing:0.05em">Stockage</p><p class="font-semibold">${escapeHtml(inv.storage?.name)}</p></div>
                            <div><p class="text-xs text-gray-500" style="text-transform:uppercase;letter-spacing:0.05em">Type</p><p class="font-semibold">${typeLabels[inv.type] || inv.type}</p></div>
                            <div><p class="text-xs text-gray-500" style="text-transform:uppercase;letter-spacing:0.05em">Date</p><p class="font-semibold">${formatDate(inv.createdAt)}</p></div>
                        </div>
                        ${(inv.postName || inv.postNumber) ? '<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--gray-100)"><p class="text-sm text-gray-600">Poste : ' + escapeHtml(inv.postName || '') + (inv.postNumber ? ' (#' + escapeHtml(inv.postNumber) + ')' : '') + '</p></div>' : ''}
                        ${inv.greeting ? '<div style="margin-top:8px"><p class="text-sm text-gray-500" style="font-style:italic">"' + escapeHtml(inv.greeting) + '"</p></div>' : ''}
                    </div>
                `;

                for (const [storageName, items] of groups) {
                    html += `<div class="card mb-4"><h3 class="font-semibold text-lg mb-3">${escapeHtml(storageName)}</h3><div class="space-y-2">`;
                    items.forEach(item => {
                        const isMissing = item.quantityFound < item.expected;
                        const wasAdded = item.quantityAdded > 0;
                        html += `<div class="flex items-center justify-between p-3" style="border-radius:8px;${isMissing ? 'background:var(--red-50);border:1px solid var(--red-200)' : 'background:var(--gray-50)'}">
                            <div class="flex items-center gap-2">
                                ${isMissing ? '<span style="color:var(--red-500)">' + icons.alertTriangle + '</span>' : '<span style="color:var(--green-500)">' + icons.checkCircle + '</span>'}
                                <span class="text-sm font-medium">${escapeHtml(item.material.name)}</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="text-gray-500">Attendu: ${item.expected}</span>
                                <span ${isMissing ? 'class="text-red-600 font-semibold"' : ''}>Trouvé: ${item.quantityFound}</span>
                                ${wasAdded ? '<span class="text-green-600 font-semibold flex items-center gap-1">' + icons.plusCircle + ' Ajouté: ' + item.quantityAdded + '</span>' : ''}
                            </div>
                        </div>`;
                    });
                    html += '</div></div>';
                }

                document.getElementById('page-content').innerHTML = html;
            } catch (err) {
                document.getElementById('page-content').innerHTML = '<p style="text-align:center;padding:40px;color:var(--gray-500)">Inventaire non trouvé</p>';
            }
        }

        loadDetail();
    </script>
</body>
</html>
