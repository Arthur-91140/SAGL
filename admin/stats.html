<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <title>Statistiques - SAGL</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><h1>SAGL</h1><p>Gestion d'inventaire</p></div>
            <nav class="sidebar-nav">
                <a href="index.html"><span class="icon" id="nav-icon-dashboard"></span> Tableau de bord</a>
                <a href="materials.html"><span class="icon" id="nav-icon-materials"></span> Matériels</a>
                <a href="storages.html"><span class="icon" id="nav-icon-storages"></span> Stockages</a>
                <a href="history.html"><span class="icon" id="nav-icon-history"></span> Historique</a>
                <a href="stats.html" class="active"><span class="icon" id="nav-icon-stats"></span> Statistiques</a>
                <a href="settings.html"><span class="icon" id="nav-icon-settings"></span> Paramètres</a>
            </nav>
            <div class="sidebar-footer"><p>SAGL v1.0</p></div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <button class="menu-btn" id="menu-btn"></button>
                <div style="flex:1"></div>
                <div class="topbar-right">
                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notification-btn"><span id="notification-bell-icon"></span><span class="notification-count" id="notification-count" style="display:none">0</span></button>
                        <div class="notification-dropdown" id="notification-dropdown" style="display:none"><div class="notification-dropdown-header">Notifications (<span id="notif-count-text">0</span>)</div><div id="notification-list"></div></div>
                    </div>
                    <span class="topbar-username" id="topbar-username"></span>
                    <button class="btn-icon" id="logout-btn" title="Déconnexion"></button>
                </div>
            </header>

            <main class="page-content" id="page-content">
                <div class="spinner-center"><div class="spinner"></div></div>
            </main>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script>
        if (!checkAuth()) throw new Error('Not authenticated');

        document.getElementById('menu-btn').innerHTML = icons.menu;
        document.getElementById('notification-bell-icon').innerHTML = icons.bell;
        document.getElementById('logout-btn').innerHTML = icons.logout;
        document.getElementById('nav-icon-dashboard').innerHTML = icons.dashboard;
        document.getElementById('nav-icon-materials').innerHTML = icons.package;
        document.getElementById('nav-icon-storages').innerHTML = icons.folderTree;
        document.getElementById('nav-icon-history').innerHTML = icons.clipboardList;
        document.getElementById('nav-icon-stats').innerHTML = icons.barChart;
        document.getElementById('nav-icon-settings').innerHTML = icons.settings;
        initSidebar();

        const typeLabels = { START: 'Début', END: 'Fin', OTHER: 'Autre' };
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

        async function handleExport(format) {
            try {
                const blob = format === 'csv' ? await exports_.csv() : await exports_.pdf();
                if (format === 'pdf') {
                    // PDF is returned as HTML, open in new window
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'stock-sagl-' + new Date().toISOString().split('T')[0] + '.' + format;
                    a.click();
                    URL.revokeObjectURL(url);
                }
                showToast('Export ' + format.toUpperCase() + ' téléchargé');
            } catch (err) { showToast(err.message, 'error'); }
        }

        function renderBarChart(data, dataKey, maxHeight, color) {
            if (!data || data.length === 0) return '<p class="text-gray-500 text-sm text-center" style="padding:32px">Pas de données</p>';
            const max = Math.max(...data.map(d => d[dataKey]), 1);
            let html = '<div class="bar-chart">';
            data.forEach(d => {
                const pct = (d[dataKey] / max) * 100;
                html += '<div class="bar-item' + (color === 'red' ? ' red' : '') + '" style="height:' + Math.max(pct, 2) + '%"><div class="bar-tooltip">' + escapeHtml(d.name || d.date || '') + ': ' + d[dataKey] + '</div></div>';
            });
            html += '</div><div class="bar-labels">';
            data.forEach(d => {
                const label = d.name || (d.date ? new Date(d.date).toLocaleDateString('fr-FR', {day:'2-digit',month:'2-digit'}) : '');
                html += '<span title="' + escapeHtml(label) + '">' + escapeHtml(label.length > 8 ? label.substring(0,8) + '…' : label) + '</span>';
            });
            html += '</div>';
            return html;
        }

        async function loadStats() {
            try {
                const data = await stats.get();

                let html = `
                    <div class="page-header">
                        <h1 class="page-title">Statistiques</h1>
                        <div class="flex gap-2">
                            <button class="btn-secondary text-sm" onclick="handleExport('csv')">${icons.download} CSV</button>
                            <button class="btn-secondary text-sm" onclick="handleExport('pdf')">${icons.fileText} PDF</button>
                        </div>
                    </div>

                    <div class="grid-2-col">
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Inventaires par type</h2>
                            ${data.inventoriesByType && data.inventoriesByType.length > 0
                                ? '<div class="space-y-2">' + data.inventoriesByType.map((d, i) =>
                                    '<div class="flex items-center justify-between p-3" style="background:var(--gray-50);border-radius:8px">' +
                                    '<div class="flex items-center gap-2"><span style="width:12px;height:12px;border-radius:50%;background:' + COLORS[i % COLORS.length] + ';display:inline-block"></span>' +
                                    '<span class="text-sm font-medium">' + (typeLabels[d.type] || d.type) + '</span></div>' +
                                    '<span class="text-sm font-semibold">' + d.count + '</span></div>'
                                  ).join('') + '</div>'
                                : '<p class="text-gray-500 text-sm text-center" style="padding:32px">Pas de données</p>'
                            }
                        </div>

                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Inventaires (30 derniers jours)</h2>
                            ${renderBarChart(data.inventoriesPerDay, 'count', 200, 'blue')}
                        </div>

                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Matériels les plus consommés</h2>
                            ${data.topConsumed && data.topConsumed.length > 0
                                ? '<div class="space-y-2">' + data.topConsumed.map(d =>
                                    '<div class="flex items-center justify-between p-2" style="background:var(--gray-50);border-radius:6px">' +
                                    '<span class="text-sm">' + escapeHtml(d.name) + '</span>' +
                                    '<span class="text-sm font-semibold text-primary-600">' + d.total + '</span></div>'
                                  ).join('') + '</div>'
                                : '<p class="text-gray-500 text-sm text-center" style="padding:32px">Pas de données</p>'
                            }
                        </div>

                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Matériels les plus souvent manquants</h2>
                            ${data.topMissing && data.topMissing.length > 0
                                ? '<div class="space-y-2">' + data.topMissing.map(d =>
                                    '<div class="flex items-center justify-between p-2" style="background:var(--gray-50);border-radius:6px">' +
                                    '<span class="text-sm">' + escapeHtml(d.name) + '</span>' +
                                    '<span class="text-sm font-semibold text-red-600">' + d.missingCount + ' fois</span></div>'
                                  ).join('') + '</div>'
                                : '<p class="text-gray-500 text-sm text-center" style="padding:32px">Pas de données</p>'
                            }
                        </div>

                        <div class="card col-span-2">
                            <h2 class="text-lg font-semibold mb-4">État de la réserve locale</h2>
                            ${data.stockStatus && data.stockStatus.length > 0
                                ? '<div class="table-container"><table><thead><tr><th>Matériel</th><th class="text-center">Quantité</th><th class="text-center">Seuil</th><th class="text-center">État</th></tr></thead><tbody>' +
                                  data.stockStatus.map(item => {
                                      const isLow = item.threshold && item.quantity <= item.threshold;
                                      const isEmpty = item.quantity === 0;
                                      let badge = '<span class="badge badge-green">OK</span>';
                                      if (isEmpty) badge = '<span class="badge badge-red">Épuisé</span>';
                                      else if (isLow) badge = '<span class="badge badge-amber">Faible</span>';
                                      return '<tr><td class="text-sm">' + escapeHtml(item.name) + '</td>' +
                                          '<td class="text-center text-sm font-semibold' + (isEmpty ? ' text-red-600' : (isLow ? '" style="color:var(--amber-600)' : '')) + '">' + item.quantity + '</td>' +
                                          '<td class="text-center text-sm text-gray-500">' + (item.threshold || '-') + '</td>' +
                                          '<td class="text-center">' + badge + '</td></tr>';
                                  }).join('') + '</tbody></table></div>'
                                : '<p class="text-gray-500 text-sm text-center" style="padding:32px">Aucun stock en réserve</p>'
                            }
                        </div>
                    </div>
                `;

                document.getElementById('page-content').innerHTML = html;
            } catch (err) {
                document.getElementById('page-content').innerHTML = '<div class="text-center text-gray-500" style="padding:40px">Erreur de chargement</div>';
            }
        }

        loadStats();
    </script>
</body>
</html>
