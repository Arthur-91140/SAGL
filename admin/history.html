<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <title>Historique - SAGL</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><h1>SAGL</h1><p>Gestion d'inventaire</p></div>
            <nav class="sidebar-nav">
                <a href="index.html"><span class="icon" id="nav-icon-dashboard"></span> Tableau de bord</a>
                <a href="materials.html"><span class="icon" id="nav-icon-materials"></span> Matériels</a>
                <a href="storages.html"><span class="icon" id="nav-icon-storages"></span> Stockages</a>
                <a href="history.html" class="active"><span class="icon" id="nav-icon-history"></span> Historique</a>
                <a href="stats.html"><span class="icon" id="nav-icon-stats"></span> Statistiques</a>
                <a href="settings.html"><span class="icon" id="nav-icon-settings"></span> Paramètres</a>
            </nav>
            <div class="sidebar-footer"><p>SAGL v1.0</p></div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <button class="menu-btn" id="menu-btn"></button>
                <div style="flex:1"></div>
                <div class="topbar-right">
                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notification-btn"><span id="notification-bell-icon"></span><span class="notification-count" id="notification-count" style="display:none">0</span></button>
                        <div class="notification-dropdown" id="notification-dropdown" style="display:none"><div class="notification-dropdown-header">Notifications (<span id="notif-count-text">0</span>)</div><div id="notification-list"></div></div>
                    </div>
                    <span class="topbar-username" id="topbar-username"></span>
                    <button class="btn-icon" id="logout-btn" title="Déconnexion"></button>
                </div>
            </header>

            <main class="page-content" id="page-content">
                <div class="spinner-center"><div class="spinner"></div></div>
            </main>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script>
        if (!checkAuth()) throw new Error('Not authenticated');

        document.getElementById('menu-btn').innerHTML = icons.menu;
        document.getElementById('notification-bell-icon').innerHTML = icons.bell;
        document.getElementById('logout-btn').innerHTML = icons.logout;
        document.getElementById('nav-icon-dashboard').innerHTML = icons.dashboard;
        document.getElementById('nav-icon-materials').innerHTML = icons.package;
        document.getElementById('nav-icon-storages').innerHTML = icons.folderTree;
        document.getElementById('nav-icon-history').innerHTML = icons.clipboardList;
        document.getElementById('nav-icon-stats').innerHTML = icons.barChart;
        document.getElementById('nav-icon-settings').innerHTML = icons.settings;
        initSidebar();

        const typeLabels = { START: 'Début de mission', END: 'Fin de mission', OTHER: 'Autre' };
        const typeBadges = { START: 'badge-green', END: 'badge-blue', OTHER: 'badge-gray' };

        let filters = { type: '', storageId: '', page: '1' };
        let storagesList = [];
        let showFilters = false;

        storages.list().then(list => { storagesList = list; }).catch(() => {});

        async function loadInventories() {
            try {
                const params = { page: filters.page, limit: '20' };
                if (filters.type) params.type = filters.type;
                if (filters.storageId) params.storageId = filters.storageId;
                const data = await inventories.list(params);
                renderHistory(data);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function renderHistory(data) {
            const invList = data.inventories || [];
            const pag = data.pagination || { page: 1, totalPages: 1, total: 0 };

            let html = `
                <div class="page-header">
                    <h1 class="page-title">Historique des inventaires</h1>
                    <button class="btn-secondary" onclick="toggleFilters()">${icons.filter} Filtres</button>
                </div>
            `;

            if (showFilters) {
                html += `<div class="card mb-4 flex flex-wrap gap-4">
                    <div><label class="text-xs font-medium text-gray-600" style="display:block;margin-bottom:4px">Type</label>
                    <select class="input-field" style="width:192px" onchange="filters.type=this.value;filters.page='1';loadInventories()">
                        <option value="">Tous</option>
                        <option value="START" ${filters.type==='START'?'selected':''}>Début de mission</option>
                        <option value="END" ${filters.type==='END'?'selected':''}>Fin de mission</option>
                        <option value="OTHER" ${filters.type==='OTHER'?'selected':''}>Autre</option>
                    </select></div>
                    <div><label class="text-xs font-medium text-gray-600" style="display:block;margin-bottom:4px">Stockage</label>
                    <select class="input-field" style="width:192px" onchange="filters.storageId=this.value;filters.page='1';loadInventories()">
                        <option value="">Tous</option>
                        ${storagesList.map(s => '<option value="' + s.id + '"' + (filters.storageId===String(s.id)?'selected':'') + '>' + escapeHtml(s.name) + '</option>').join('')}
                    </select></div>
                </div>`;
            }

            html += '<div class="card no-padding">';

            if (invList.length === 0) {
                html += '<div style="padding:32px;text-align:center;color:var(--gray-500)">Aucun inventaire trouvé</div>';
            } else {
                html += '<div class="table-container"><table><thead><tr>';
                html += '<th>Date</th><th>Secouriste</th><th class="hidden-tablet">Stockage</th><th class="hidden-mobile">Type</th><th class="text-right">Détails</th>';
                html += '</tr></thead><tbody>';
                invList.forEach(inv => {
                    html += `<tr>
                        <td class="text-sm">${formatDate(inv.createdAt)}</td>
                        <td class="text-sm font-medium">${escapeHtml(inv.rescuerName)}</td>
                        <td class="text-sm hidden-tablet">${escapeHtml(inv.storage?.name || '')}</td>
                        <td class="hidden-mobile"><span class="badge ${typeBadges[inv.type] || ''}">${typeLabels[inv.type] || inv.type}</span></td>
                        <td class="text-right"><a href="inventory-detail.html?id=${inv.id}" class="text-primary-600 text-sm flex items-center justify-end gap-1">${icons.eye} <span class="hidden-mobile">Voir</span></a></td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            html += '</div>';

            if (pag.totalPages > 1) {
                html += `<div class="pagination">
                    <p class="pagination-info">${pag.total} résultat(s)</p>
                    <div class="pagination-controls">
                        <button class="btn-secondary" style="padding:8px" ${pag.page<=1?'disabled':''} onclick="filters.page=String(${pag.page-1});loadInventories()">${icons.chevronLeft}</button>
                        <span>${pag.page} / ${pag.totalPages}</span>
                        <button class="btn-secondary" style="padding:8px" ${pag.page>=pag.totalPages?'disabled':''} onclick="filters.page=String(${pag.page+1});loadInventories()">${icons.chevronRight}</button>
                    </div>
                </div>`;
            }

            document.getElementById('page-content').innerHTML = html;
        }

        function toggleFilters() {
            showFilters = !showFilters;
            loadInventories();
        }

        loadInventories();
    </script>
</body>
</html>
